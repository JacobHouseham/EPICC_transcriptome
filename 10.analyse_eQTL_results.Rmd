---
title: "Analyse eQTL results"
author: "Dr Jacob Househam"
date: "23/06/2021"
output: html_document
---

```{r library}
library(data.table);library(dplyr);library(wesanderson);library(EnhancedVolcano);library(stringr);library(pheatmap);library(vioplot)
```

```{r setup}
ngroupcol= c(wes_palette("Darjeeling2",5)[2],wes_palette('Darjeeling1',5)[2],wes_palette('FantasticFox1',5)[5]);names(ngroupcol) <- as.numeric(c(1:3))
datacol <- wes_palette("Cavalcanti1")[c(2,5,3,4)]
twocol <- c('gray55','gray80');patcol <- c('gray80')
vars <- c('CNA','Mut','Purity','Tissue')
newcol <- wes_palette("Cavalcanti1")[c(2,5,3,4)];names(newcol) <- vars
for(j in c(2:length(matchsam))) { patcol <- c(patcol,ifelse(matchpat[j]==matchpat[j-1],patcol[j-1],twocol[which(twocol!=patcol[j-1])])) }
```

## Load eQTL results and input data
```{r load_data}
# Load eQTL results and data matrices
newallDF <- readRDS('results/eqtl_analysis_results.rds')
listmat <- readRDS('results/eqtl_data_matrices.rds')
matchsam <- colnames(listmat$Expression);matchpat <- gsub('(C\\d+)_\\S+','\\1',matchsam)
for(j in c(2:length(matchsam))) { patcol <- c(patcol,ifelse(matchpat[j]==matchpat[j-1],patcol[j-1],twocol[which(twocol!=patcol[j-1])])) }

# Pre-filter results into by specific filters
# All significant models
modsigdf <- newallDF[which(newallDF$ModeladjP<0.01),];row.names(modsigdf) <- c(1:nrow(modsigdf))
# Models significant for Mut
mutsigdf <- modsigdf[which(modsigdf$MutadjP<0.05),];mutsigdf <- mutsigdf[order(mutsigdf$MutP),];row.names(mutsigdf) <- c(1:nrow(mutsigdf))
mutsigdf$Direction <- ifelse(mutsigdf$Mutes>0,'Positive','Negative')
# Models significant for Enh mut and subclonal in at least one tumour
enhsubdf <- mutsigdf[which(mutsigdf$ClonalityAll!='clonal' & mutsigdf$Type %in% c('Enh','Both')),];row.names(enhsubdf) <- c(1:nrow(enhsubdf))

```

## Plot summaries of eQTL analysis results (Figure 5 A&B)
```{r bar_and_violin_plots}
# Plot barplot of number of significant models per data type
# Figure 5A
pdf('figures/eqtl_sig_unique_genes.pdf',width=9)
par(font=2,mar=c(3.6,7,2.1,1.1),xpd=F);options(scipen=-1)
signum <- rep(0,4);names(signum) <- vars
for(var in names(signum)) { signum[var] <- length(unique(modsigdf[which(modsigdf[,paste0(var,'adjP')]<0.05),'Ensembl'])) }
barplot(signum,ylim=c(0,1200),col=datacol,border=NA,las=1,font=2,cex.axis=1.75,cex.names=1.75)
mtext(side=2,text='Significant genes',line=4.5,cex=1.75,xpd=T)
mtext(side=3,text=paste0('n=',length(unique(modsigdf$Ensembl)),' unique genes with sig models'),line=0.5,cex=1.5,xpd=T)
dev.off()

# Plot violin plot of regression coefficients per data type
# Figure 5B
pdf('~/Documents/EPICC/Final/b.simpler_eQTL/eqtl_regression_coefficients.pdf',width=9)
par(font=2,font.axis=2,cex.axis=1.5,mar=c(3.1,4.5,1.1,0.6))
tmpdf <- modsigdf[,paste0(vars,'es')];colnames(tmpdf) <- vars
vioplot(tmpdf,col=datacol,ylim=c(-4,6),border=datacol,axes=F,las=1,h=0.2)
abline(h=0,lty=2)
vioplot(tmpdf,col=datacol,ylim=c(-4,6),border=datacol,axes=F,las=1,h=0.2,add=T)
mtext(side=2,text='Regression coefficient',line=2.8,cex=1.5)
dev.off()

```

## Plot volcano plots for CNAs and Muts (Figure 5 C&D)
```{r volcano_plots}
limxmin <- c(-1,-4,-2,-3.2);limxmax <- c(1.1,6.2,2.2,2.3);limy <- c(14,19,5,13)
names(limxmin) <- names(limxmax) <- names(limy) <- vars
pdf('figures/eqtl_volcano_plots.pdf')
for(var in vars) {
  newdf <- modsigdf[order(modsigdf[,paste0(var,'adjP')]),];newdf$NewName <- newdf$Gene
  newdf[which(duplicated(newdf$NewName)),'NewName'] <- ''
  
  plot(EnhancedVolcano(newdf,lab=newdf$NewName,x=paste0(var,'es'),y=paste0(var,'adjP'),labSize=3,pointSize=1.25,
                       pCutoff=0.05,FCcutoff=0,selectLab=newdf$NewName[which(newdf$NewName!='' & newdf[,paste0(var,'adjP')]<0.05)],
                       xlim=c(limxmin[var],limxmax[var]),ylim=c(0,limy[var]),shape=16,
                       title=var,subtitle='',caption='',xlab='Regression coefficient',col=c('dimgray','dimgray','dimgray',as.character(newcol[var])),ylab=bquote(~-Log[10] ~ italic(Padj))) + theme(legend.position = 'none'))
}
dev.off()
```

## Plot the regression coefficients for NS mut and Enh mut separately
## Figure 5E
```{r ns_vs_enh_plot}
# Split into NS and Enh muts (some can be both)
nsmut <- mutsigdf[which(mutsigdf$Type %in% c('NS','Both')),]
enhmut <- mutsigdf[which(mutsigdf$Type %in% c('Enh','Both')),]

# Get the number of positive/negative eQTLs per mutation type
matcomp <- matrix(0L,nrow=2,ncol=2);row.names(matcomp) <- c('NS','Enh')
colnames(matcomp) <- c('Pos','Neg')
matcomp['NS','Pos'] <- length(which(nsmut$Mutes>0))
matcomp['NS','Neg'] <- length(which(nsmut$Mutes<0))
matcomp['Enh','Pos'] <- length(which(enhmut$Mutes>0))
matcomp['Enh','Neg'] <- length(which(enhmut$Mutes<0))

# Plot the regression coefficients of both to illustrate difference
pdf('figures/violin_ns_vs_enh_effects.pdf',width=4,height=8)
par(mar=c(4,4.5,1,1),font=2,font.axis=2,font.lab=2,cex.axis=1.5)
vioplot(nsmut$Mutes,enhmut$Mutes,names=c('NS','Enh'),col=wes_palette("Cavalcanti1")[c(5,1)],ylim=c(-4,6),border=wes_palette("Cavalcanti1")[c(5,1)],axes=F,las=1)
abline(h=0,lty=2)
vioplot(nsmut$Mutes,enhmut$Mutes,col=wes_palette("Cavalcanti1")[c(5,1)],ylim=c(-4,6),border=wes_palette("Cavalcanti1")[c(5,1)],axes=F,las=1,add=T)
mtext(side=2,text='Regression coefficient',line=2.8,cex=1.5)
mtext(side=1,at=c(1,2),text=paste0('n = ',c(nrow(nsmut),nrow(enhmut))),line=2.5,cex=1.5)
dev.off()
```

## Perform analysis of gene groups vs eQTL associated genes and plot
## Figure 5F
```{r gene_groups_vs_eqtl}
# Load gene groups 1-3 information
genedf <- readRDS('~/Documents/EPICC/Final/1.expressionFiltering/gene_clustering_and_id_conversion.rds')
genedf <- genedf[which(genedf$Group!='4'),]

# For each gene groups get the number of genes which are eQTL associated
newmat <- matrix(0L,nrow=2,ncol=3);colnames(newmat) <- c('1','2','3')
row.names(newmat) <- c('non-eQTL','eQTL')
for(grp in colnames(newmat)) {
  curgenedf <- genedf[which(genedf$Group==grp),]
  newmat['non-eQTL',grp] <- length(which(curgenedf$ensembl_gene_id %ni% mutsigdf$Ensembl))
  newmat['eQTL',grp] <- length(which(curgenedf$ensembl_gene_id %in% mutsigdf$Ensembl))
}
# Perform chi-squared test
res <- chisq.test(newmat)

# Turn into proportions for plotting
newprop <- newmat
for(grp in colnames(newmat)) {
  newprop['non-eQTL',grp] <- newmat['non-eQTL',grp]/sum(newmat['non-eQTL',])
  newprop['eQTL',grp] <- newmat['eQTL',grp]/sum(newmat['eQTL',])
}
plotmat <- t(newprop*100)

# Define positions for proportion text annotations
newpos <- plotmat;newpos[1,1] <- plotmat[1,1]/2
newpos[2,1] <- (plotmat[2,1]/2)+plotmat[1,1];newpos[3,1] <- (plotmat[3,1]/2)+plotmat[2,1]+plotmat[1,1]
newpos[1,2] <- plotmat[1,2]/2
newpos[2,2] <- (plotmat[2,2]/2)+plotmat[1,2];newpos[3,2] <- (plotmat[3,2]/2)+plotmat[2,2]+plotmat[1,2]

# Plot Figure 5F
pdf('figures/gene_groups_vs_eQTL.pdf',height=9,width=4.5)
par(mar=c(3,5,2,4),font=2,font.axis=2,font.lab=2,cex.axis=1.3)
xx <- barplot(plotmat,col=ngroupcol,las=1,border=NA)
text(x=rep(xx,each=3),y=newpos,labels=paste0(round(plotmat,digits=1),'%'),col='white',cex=1.25)
mtext(side=2,text='% of genes',line=3,cex=1.5)
legend(x=2.45,y=100,xpd=T,title='Group',legend=c('3','2','1'),fill=rev(ngroupcol),bty='n',border=NA)
dev.off()
```

## Calculate the clonality proportions of eQTL-associated genes and plot
## Figure 5G
```{r clonality_vs_eqtl}
# Define new data frame with a row for each unique gene in eQTL analysis
newdf <- data.frame(Gene=unique(newallDF$Ensembl),eQTL=ifelse(unique(newallDF$Ensembl) %in% mutsigdf$Ensembl,'eQTL','non-eQTL'),
                    Clonality='clonal')

# For each unique gene, define as subclonal if it has at least one subclonal mutation
for(gen in newdf$Gene) {
  curclon <- paste(sort(unique(newallDF[which(newallDF$Ensembl==gen),'ClonalityRNA'])),collapse='/')
  if(curclon!='clonal') { newdf[which(newdf$Gene==gen),'Clonality'] <- 'subclonal' }
}

# Get matrix of whether gene has any subclonal mutations and whether
# it has any significant eQTLs
mat <- matrix(0L,nrow=2,ncol=2);row.names(mat) <- c('non-eQTL','eQTL')
colnames(mat) <- c('clonal','subclonal')
mat['non-eQTL','clonal'] <- length(which(newdf$eQTL=='non-eQTL' & newdf$Clonality=='clonal'))
mat['non-eQTL','subclonal'] <- length(which(newdf$eQTL=='non-eQTL' & newdf$Clonality!='clonal'))
mat['eQTL','clonal'] <- length(which(newdf$eQTL!='non-eQTL' & newdf$Clonality=='clonal'))
mat['eQTL','subclonal'] <- length(which(newdf$eQTL!='non-eQTL' & newdf$Clonality!='clonal'))
res <- chisq.test(mat)

# Turn into proportions for plotting
probmat <- mat
probmat['non-eQTL',] <- mat['non-eQTL',]/sum(mat['non-eQTL',])*100
probmat['eQTL',] <- mat['eQTL',]/sum(mat['eQTL',])*100

# Plot Figure 5G
pdf('figures/clonality_chiplot.newclo.pdf',height=9,width=4)
par(mar=c(3,4.5,3,1),font=2,font.axis=2,font.lab=2,cex.axis=1.25);options(scipen=1)
xx <- barplot(t(probmat[,c(2:1)]),beside=F,ylim=c(0,100),border=NA,axes=F,horiz=F,las=1,col=c(wes_palette("Cavalcanti1")[1],wes_palette("GrandBudapest2")[4]))
axis(side=2,cex.axis=1.25,line=0,las=2)
mtext(side=2,text='% of genes tested',line=3,cex=1.5)
mtext(side=3,text=paste0('chi-squared test p=',signif(res$p.value,2)),line=1,cex=1)
legend(x=1.6,y=90,xpd=T,cex=1,legend=colnames(mat),fill=c(wes_palette("GrandBudapest2")[4],wes_palette("Cavalcanti1")[1]),border=NA)
dev.off()
```

## Calculate the proportion of eQTLs that are phylo, and split by clonality
## Figure 5H
```{r eqtl_vs_phylo_vs_clonality}
# Load recurrence of phylogenetic genes result
phylogen <- readRDS('results/reccurent_phylogenetic_genes.rds')
matchgene <- row.names(phylogen)

# Filter only for genes that were analysed for eQTLs
matchgene <- matchgene[which(matchgene %in% newallDF$Ensembl)]
phylogen <- phylogen[matchgene,]

# Get the number of eQTLs that are in phlogenes, also split by clonality
recphylo <- phylogen[which(phylogen$NumRec>=3),];row.names(recphylo) <- c(1:nrow(recphylo))
varres <- newallDF
varres$QTL <- ifelse(varres$ModeladjP<0.01 & varres$MutadjP<0.05,'eQTL','non-eQTL')
varres$Phylo <- ifelse(varres$Ensembl %in% recphylo$ensembl_gene_id,'Phylo','non-Phylo')
# If any tumour is subclonal for mutation - mark as subclonal
varres$NewClonality <- varres$ClonalityRNA;varres[which(varres$ClonalityRNA!='clonal'),'NewClonality'] <- 'subclonal'

# Create matrices and run fisher tests
# All
matvar <- rbind(c(length(which(varres$QTL=='non-eQTL' & varres$Phylo=='non-Phylo')), # Never an eQTL or recurrent phylo gene
                  length(which(varres$QTL=='eQTL' & varres$Phylo=='non-Phylo'))), # At least once an eQTL and not a recurrent phylo gene
                c(length(which(varres$QTL=='non-eQTL' & varres$Phylo=='Phylo')), # Never an eQTL and is a recurrent phylo gene
                  length(which(varres$QTL=='eQTL' & varres$Phylo=='Phylo')))) # At least once an eQTL and is a recurrent phylo gene
res_all <- fisher.test(matvar)

# Subclonal
varres_sub <- varres[which(varres$NewClonality=='subclonal'),]
matvar_sub <- rbind(c(length(which(varres_sub$QTL=='non-eQTL' & varres_sub$Phylo=='non-Phylo')), # Never an eQTL or recurrent phylo gene
                  length(which(varres_sub$QTL=='eQTL' & varres_sub$Phylo=='non-Phylo'))), # At least once an eQTL and not a recurrent phylo gene
                c(length(which(varres_sub$QTL=='non-eQTL' & varres_sub$Phylo=='Phylo')), # Never an eQTL and is a recurrent phylo gene
                  length(which(varres_sub$QTL=='eQTL' & varres_sub$Phylo=='Phylo')))) # At least once an eQTL and is a recurrent phylo gene
res_sub <- fisher.test(matvar_sub)

# Clonal
varres_clo <- varres[which(varres$NewClonality=='clonal'),]
matvar_clo <- rbind(c(length(which(varres_clo$QTL=='non-eQTL' & varres_clo$Phylo=='non-Phylo')), # Never an eQTL or recurrent phylo gene
                      length(which(varres_clo$QTL=='eQTL' & varres_clo$Phylo=='non-Phylo'))), # At least once an eQTL and not a recurrent phylo gene
                    c(length(which(varres_clo$QTL=='non-eQTL' & varres_clo$Phylo=='Phylo')), # Never an eQTL and is a recurrent phylo gene
                      length(which(varres_clo$QTL=='eQTL' & varres_clo$Phylo=='Phylo')))) # At least once an eQTL and is a recurrent phylo gene
res_clo <- fisher.test(matvar_clo)

# Compile matrices and fisher test 
qtlphy <- data.frame(eQTL_Type=c('All','Sub-clonal','Clonal'),
                     NonQTLNonPhy=c(matvar[1,1],matvar_sub[1,1],matvar_clo[1,1]),
                     QTLNonPhy=c(matvar[1,2],matvar_sub[1,2],matvar_clo[1,2]),
                     NonQTLPhy=c(matvar[2,1],matvar_sub[2,1],matvar_clo[2,1]),
                     QTLPhy=c(matvar[2,2],matvar_sub[2,2],matvar_clo[2,2]),
                     OR=c(res_all$estimate,res_sub$estimate,res_clo$estimate),
                     pvalue=c(res_all$p.value,res_sub$p.value,res_clo$p.value))

# Make matrix of eQTL proportions for phylog/non-phylo + all/subclonal/clonal - for plotting
mat <- matrix(0L,nrow=3,ncol=2);row.names(mat) <- c('All','Subclonal','Clonal');colnames(mat) <- c('Non-Phylo','Phylo')
mat[1,1] <- matvar[1,2]/sum(matvar[1,])*100;mat[1,2] <- matvar[2,2]/sum(matvar[2,])*100
mat[2,1] <- matvar_sub[1,2]/sum(matvar_sub[1,])*100;mat[2,2] <- matvar_sub[2,2]/sum(matvar_sub[2,])*100
mat[3,1] <- matvar_clo[1,2]/sum(matvar_clo[1,])*100;mat[3,2] <- matvar_clo[2,2]/sum(matvar_clo[2,])*100

# Plot Figure 5H
pdf('figures/qtl_vs_phylo_chiplot.pdf')
par(mar=c(3,4.5,3,1),font=2,font.axis=2,font.lab=2,cex.axis=1.25)
xx <- barplot(t(mat),beside=T,ylim=c(0,10),border=c(wes_palette("Cavalcanti1")[c(2,2)],wes_palette("Cavalcanti1")[c(1,1)],wes_palette("GrandBudapest2")[c(4,4)]),axes=F,horiz=F,las=1,density=c(NA,20,NA,20),
              col=c(wes_palette("Cavalcanti1")[c(2,2)],wes_palette("Cavalcanti1")[c(1,1)],wes_palette("GrandBudapest2")[c(4,4)]))
axis(side=2,cex.axis=1.25,line=0,las=2)
mtext(side=2,text='% of gene-mutation combinations that are eQTLs',line=3,cex=1)
mtext(side=3,at=apply(xx,2,function(x){x[2]-(x[2]-x[1])/2 }),text=paste0('OR=',signif(qtlphy$OR,2)),line=1.5,cex=1)
mtext(side=3,at=apply(xx,2,function(x){x[2]-(x[2]-x[1])/2 }),text=paste0('p=',signif(qtlphy$pvalue,2)),line=0.5,cex=1)
legend(x=6.5,y=9,xpd=T,cex=1,legend=colnames(mat),bty='n',fill='gray60',density=c(NA,20),border=c('gray60'))
dev.off()
```

