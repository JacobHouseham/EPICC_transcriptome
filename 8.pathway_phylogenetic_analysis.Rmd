---
title: "Run and plot pathway enrichment phylogenetic signal analysis"
author: "Dr Jacob Househam"
date: "21/06/2021"
output: html_document
---

```{r library}
library(phytools);library(data.table);library(DESeq2);library(GSVA);library(msigdbr);library(matrixStats);library(org.Hs.eg.db);library(wesanderson);library(pheatmap);library(phangorn)
```

```{r setup}
ngroupcol= c(wes_palette("Darjeeling2",5)[2],wes_palette('Darjeeling1',5)[2],wes_palette('FantasticFox1',5)[c(5,2)])
names(ngroupcol) <- as.numeric(c(1:4))
colhall <- c('#007F00','#CC0000','purple','#0000E5','#D3D3D3');names(colhall) <- c('Immune','Oncogenic','Cellular Stress','Stromal','Other')
col_list <- list(Group=ngroupcol,Class=colhall)
```

## Gather pathways for analysis
```{r pathway_gather}
m_df = msigdbr(species = "Homo sapiens", category = "H")
Hallmark_cancer_list = split(x = m_df$entrez_gene, f = m_df$gs_name)
names(Hallmark_cancer_list) <- gsub('HALLMARK_(\\S+)','\\1',names(Hallmark_cancer_list))
# Remove spermatogenesis, myogenesis and pancreas_beta_cells
Hallmark_cancer_list$SPERMATOGENESIS <- NULL
Hallmark_cancer_list$MYOGENESIS <- NULL
Hallmark_cancer_list$PANCREAS_BETA_CELLS <- NULL
# Rename COMPLEMENT
Hallmark_cancer_list$COMPLEMENT_INNATE_IMMUNE_SYSTEM <- Hallmark_cancer_list$COMPLEMENT
Hallmark_cancer_list$COMPLEMENT <- NULL

# Include ISC signature and WNT_signalling
isc <- read.table('~/Documents/EPICC/PurityAdjust/merlossuarez_2011_ISC_signature.txt')[,1]
geneinfo <- fread('~/Documents/EPICC/Data/Expression/complete_gene_info.txt',data.table=F)
isc_entrez <- geneinfo[which(geneinfo$Symbol %in% isc),'Entrez']
isc_entrez <- isc_entrez[which(!is.na(isc_entrez))]
Hallmark_cancer_list$INTESTINAL_STEM_CELL <- isc_entrez
wnt_entrez <- read.table('~/Documents/EPICC/PurityAdjust/wnt_signalling_entrez.txt')[,1]
Hallmark_cancer_list$WNT_SIGNALING <- wnt_entrez
```

## Load sample data, TPM and pathway clustering
```{r pathway_gather}
treelist <- readRDS('input_files/pgls.trees.rds')
tinfo <- readRDS('input_files/pgls.infotrees.rds')

# Load tpm, convert to log(TPM+1) expression and convert to entrez gene ids
tmptpm <- fread('input_files/All_EPICC_tpm.txt');tpm <- tmptpm
for(i in c(2:ncol(tmptpm))) { tpm[,i] <- log(tmptpm[,i]+1) }
geneinfoexp <- merge(tpm,geneinfo,by='GeneID')
# Remove NA entrez genes
geneinfoexp <- geneinfoexp[!is.na(geneinfoexp$Entrez),];row.names(geneinfoexp) <- c(1:nrow(geneinfoexp))
# For now if 1 ensembl ids maps to multiple entrez, choose the first entrez
geneinfoexp[grep(',',geneinfoexp$Entrez),'Entrez'] <- gsub('^(\\S+),\\S+','\\1',geneinfoexp[grep(',',geneinfoexp$Entrez),'Entrez'])
# Temp remove duplcates
geneinfoexp <- geneinfoexp[which(!duplicated(geneinfoexp$Entrez)),];row.names(geneinfoexp) <- c(1:nrow(geneinfoexp))
# Remove genes with 0 expression for all samples
entrezexp <- geneinfoexp;row.names(entrezexp) <- entrezexp$Entrez
entrezexp <- entrezexp[,tinfo$samples]

# Input pathway clustering data
pathdf <- readRDS('results/pathway_clustering.rds')

```

## For each tumour get the phylogenetic signal (lambda) for all pathways for the 100 trees of varying branch length
```{r get_phylogenetic_signal}
for(pat in tinfo$patients) {
  trimtree <- treelist[[pat]][[1]]
  treesam <- paste0(pat,"_",trimtree$tip.label)
  
  print(paste0(pat,': ',length(treesam),' matched samples x ',nrow(pathdf),' pathways'))
  pattpm <- entrezexp[which(apply(entrezexp[,treesam],1,sd)!=0),treesam]
  
  hallmark_gsva <- gsva(data.matrix(pattpm),method='ssgsea',
                        Hallmark_cancer_list,verbose=FALSE)
  try <- as.data.frame(t(hallmark_gsva[row.names(pathdf),treesam]))
  row.names(try) <- gsub('C\\d+_(\\S+)','\\1',row.names(try))
  
  siglist <- list()
  for(i in c(1:length(treelist[[pat]]))) {
    trimtree <- treelist[[pat]][[as.character(i)]]
    
    sigphylo <- data.frame(Pathway=colnames(try),Lambda=0,Lpval=0)
    for(j in c(1:ncol(try))) {
      curgen <- try[,j];names(curgen) <- row.names(try)
      
      res <- phylosig(trimtree,curgen,method='lambda',test=T)
      sigphylo[j,'Lambda'] <- res$lambda
      sigphylo[j,'Lpval'] <- res$P
    }
    siglist[[as.character(i)]] <- sigphylo
    print(paste0(pat,': ',signif((i/length(treelist[[pat]])*100),2),'%'))
  }
  
  lam <- do.call(cbind, lapply(siglist,function(x) { x$Lambda }))
  lam_pval <- do.call(cbind, lapply(siglist,function(x) { x$Lpval }))
  resdf <- data.frame(MedLambda=rowMedians(lam),
                      LamPval=rowMedians(lam_pval))
  row.names(resdf) <- colnames(try)
  
  saveRDS(try,file=paste0('results/',pat,'_pathway_enrichment.rds'))
  saveRDS(resdf,file=paste0('results/',pat,'_pathway_lambda_data.rds'))
}
```

## Analyse and plot the results of the phylogenetic pathway enrichment analysis (Figure 4A&B and Figure S5)
```{r plot_phylogenetic_pathway_results}
reclam <- matrix(0L,nrow=nrow(pathdf),ncol=length(tinfo$patients))
colnames(reclam) <- tinfo$patients;row.names(reclam) <- row.names(pathdf)
recstars <- recpval <- reclam
pdf('figures/lambda_analysis_pathways.pdf',height=8,width=5)
for(pat in tinfo$patients) {
  resdf <- readRDS(paste0('results/',pat,'_lambda_pathway_data.rds'))
  try <- readRDS(paste0('results/',pat,'_pathway_enrichment.rds'))
  
  combdf <- merge(resdf,pathdf,by=0);row.names(combdf) <- combdf$Row.names
  combdf$MedPval <- log(combdf$LamPval,base=10)*-1
  reclam[row.names(combdf),pat] <- combdf$MedLambda
  recstars[row.names(combdf),pat] <- getstars_vec(combdf$LamPval)
  recpval[row.names(combdf),pat] <- combdf$MedPval
  
  trimtree <- treelist[[pat]][[1]]
  seldf <- combdf[which(combdf$combstars!=''),]
  
  regions <- gsub('^(\\S)\\d+_\\S+','\\1',trimtree$tip.label)
  options(scipen = -1);par(mar=c(0,0,2,0),xpd=T)
  plot.phylo(trimtree,type="phylogram",align.tip.label = T,edge.width=3,
             font=2,cex=0.9,tip.color=regcol[c(regions,'Root')],label.offset=20)
  title(main=pat)
  explot <- try
  explot <- scale_mat(explot,'column')
  explot <- explot[c(nrow(explot):1),order(combdf$MedPval,decreasing=T)]
  mybreaks <- seq(floor(min(explot)),ceiling(max(explot)),by=0.05)
  pheatmap(explot,show_rownames = F,show_colnames=T,cluster_rows=F,cluster_cols=F,treeheight_col=0,
           border_color=NA,fontsize = 6,fontsize_col = 3,
           color=wes_palette("Zissou1", length(mybreaks)-1, type = "continuous"),breaks=mybreaks,
           annotation_col=combdf[,c('MedPval','Class','Group')],
           annotation_colors=col_list)
  
  if(nrow(seldf)>1) {
    seldf <- dplyr::arrange(seldf,Group,desc(Mean_Var))
    explot <- try[,row.names(seldf)]
    explot <- scale_mat(explot,'column')
    explot <- explot[c(nrow(explot):1),order(seldf$MedPval,decreasing=T)]
    mybreaks <- seq(floor(min(explot)),ceiling(max(explot)),by=0.05)
    pheatmap(explot,show_rownames = F,show_colnames=T,cluster_rows=F,cluster_cols=F,treeheight_col=0,
             border_color=NA,fontsize = 6,fontsize_col = 3,
             color=wes_palette("Zissou1", length(mybreaks)-1, type = "continuous"),breaks=mybreaks,
             annotation_col=seldf[,c('MedPval','Class','Group')],
             annotation_colors=col_list)
  }
}
dev.off()

pathdf$Num_Sig <- rowSums(recstars!='')
```

## Plot phylogenetic recurrence of pathways (Figure 4C)
```{r plot_rec_phylo}
geneanot <- pathdf[row.names(reclam),c('Num_Sig','Group','Class')]

sortreclam <- reclam[order(geneanot$Num_Sig,geneanot$Group,decreasing=T),]
sortrecstars <- recstars[order(geneanot$Num_Sig,geneanot$Group,decreasing=T),]
sortrecpval <- recpval[order(geneanot$Num_Sig,geneanot$Group,decreasing=T),]

pdf('figures/recurrent_pathways_lambda.pdf')
mybreaks <- seq(0,ceiling(max(sortrecpval)),by=0.01)
pheatmap(sortrecpval,show_rownames=T,show_colnames=T,cluster_rows=F,cluster_cols=T,
         border_color=NA,fontsize = 6,fontsize_col=9,fontsize_row=5,
         color=wes_palette("Zissou1", length(mybreaks)-1, type = "continuous"),breaks=mybreaks,
         display_numbers=sortrecstars,fontsize_number=6,
         annotation_row=geneanot,
         annotation_colors=col_list)
dev.off()
```

## Plot fisher tests of phylo vs. pathway groups and classes (Figure 4D)
```{r plot_chisquared_test}
# Plot fisher tests
geneanot$Sig <- ifelse(geneanot$Num_Sig>=2,'Sig','NotSig')
pdf('figures/pathway_recurrent_atl2_fishplot.pdf',height=11,width=7)
par(mar=c(4.5,9,2,5),font=2,font.axis=2,font.lab=2)
plot(x=c(0.008,260),y=c(1,9),axes=F,xlab='',ylab='',col='white',log='x')
ypos <- 9;ynames <- c();pvals_vec <- c();lbnds <- c()
abline(v=1,lty=2,lwd=6)
for(cat in as.character(c(1:4))) {
  mat <- rbind(c(length(which(geneanot$Group!=cat & geneanot$Sig=='NotSig')),
                 length(which(geneanot$Group!=cat & geneanot$Sig=='Sig'))),
               c(length(which(geneanot$Group==cat & geneanot$Sig=='NotSig')),
                 length(which(geneanot$Group==cat & geneanot$Sig=='Sig'))))
  res <- fisher.test(mat)
  print(res$conf.int)
  segments(x0=res$conf.int[1],x1=res$conf.int[2],y0=ypos,col='black',lwd=10)
  points(res$estimate,ypos,pch=16,col=ngroupcol[as.character(cat)],cex=3.5)
  ypos <- ypos-1
  ynames <- c(ynames,paste0('Group ',cat))
  pvals_vec <- c(pvals_vec,res$p.value);lbnds <- c(lbnds,res$conf.int[1])
}
for(cat in names(colhall)) {
  mat <- rbind(c(length(which(geneanot$Class!=cat & geneanot$Sig=='NotSig')),
                 length(which(geneanot$Class!=cat & geneanot$Sig=='Sig'))),
               c(length(which(geneanot$Class==cat & geneanot$Sig=='NotSig')),
                 length(which(geneanot$Class==cat & geneanot$Sig=='Sig'))))
  res <- fisher.test(mat)
  print(res$conf.int)
  segments(x0=res$conf.int[1],x1=res$conf.int[2],y0=ypos,col='black',lwd=10)
  points(res$estimate,ypos,pch=16,col=colhall[cat],cex=3.5)
  ypos <- ypos-1
  ynames <- c(ynames,cat)
  pvals_vec <- c(pvals_vec,res$p.value);lbnds <- c(lbnds,res$conf.int[1])
}

mtext(side=2,at=c(9:1),text=ynames,col=c(ngroupcol,colhall),las=2,cex=1.5,line=0)
mtext(side=4,at=c(9:1),text=signif(pvals_vec,2),las=2,line=1,cex=1.25)
axis(side=1,cex.axis=1.75);mtext(side=4,at=9.6,text='p-value',line=0,cex=1.5,las=1)
mtext(side=1,text='Odds Ratio',line=2.75,cex=1.6)
dev.off()
```


